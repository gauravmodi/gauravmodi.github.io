<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>One Query To Rule Them All - Gaurav Modi</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-113190159-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-113190159-1');
    </script>



<link rel="canonical" href="https://gauravmodi.com/sql/one-sql-query-to-all-them-all/">

        <meta name="author" content="Gaurav Modi" />
        <meta name="keywords" content="sql,window functions,datetime functions" />
        <meta name="description" content="This is one query where I have put all frequently used SQL functions so to reference the syntax whenever required. NOTE: This query as whole is gibberish. WITH cte_table AS ( SELECT * FROM table ), cte_derived AS ( SELECT * FROM cte_table ) SELECT COUNT(DISTINCT artist), -- DATA TYPE CASTING CAST(sales AS DECIMAL(28 …" />

        <meta property="og:site_name" content="Gaurav Modi" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="One Query To Rule Them All"/>
        <meta property="og:url" content="https://gauravmodi.com/sql/one-sql-query-to-all-them-all/"/>
        <meta property="og:description" content="This is one query where I have put all frequently used SQL functions so to reference the syntax whenever required. NOTE: This query as whole is gibberish. WITH cte_table AS ( SELECT * FROM table ), cte_derived AS ( SELECT * FROM cte_table ) SELECT COUNT(DISTINCT artist), -- DATA TYPE CASTING CAST(sales AS DECIMAL(28 …"/>
        <meta property="article:published_time" content="2018-06-19" />
            <meta property="article:section" content="SQL" />
            <meta property="article:tag" content="sql" />
            <meta property="article:tag" content="window functions" />
            <meta property="article:tag" content="datetime functions" />
            <meta property="article:author" content="Gaurav Modi" />
            <meta property="og:image"
                  content="https://gauravmodi.com/images/gauravmodi.jpg"/>



    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://gauravmodi.com/theme/css/bootstrap.united.min.css" type="text/css"/>
    <link href="https://gauravmodi.com/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://gauravmodi.com/theme/css/pygments/default.css" rel="stylesheet">
        <link href="https://gauravmodi.com/theme/css/typogrify.css" rel="stylesheet">
    <link rel="stylesheet" href="https://gauravmodi.com/theme/css/style.css" type="text/css"/>
        <link href="https://gauravmodi.com/static/css/custom.css" rel="stylesheet">

        <link href="https://gauravmodi.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Gaurav Modi ATOM Feed"/>

        <link href="https://gauravmodi.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Gaurav Modi RSS Feed"/>


        <link href="https://gauravmodi.com/feeds/sql.atom.xml" type="application/atom+xml" rel="alternate"
              title="Gaurav Modi SQL ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://gauravmodi.com/" class="navbar-brand">
Gaurav Modi            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="https://z.umn.edu/gaurav_resume">RESUME</a></li>
                    <li><a href="https://www.linkedin.com/in/modigaurav01/">LinkedIn</a></li>
                    <li><a href="https://github.com/gauravmodi/">GitHub</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-lg-12">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    One Query To Rule Them&nbsp;All
                    <!-- Commenting out below code so to remove hyperlink to the article itself. -->
<!--                     <a href="https://gauravmodi.com/sql/one-sql-query-to-all-them-all/"
                       rel="bookmark"
                       title="Permalink to One Query To Rule Them All">
                        One Query To Rule Them&nbsp;All
                    </a> -->
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <!-- <span class="label label-default">Date</span> -->
    <span class="published">
        <!-- <i class="fa fa-calendar"></i> -->
        <time datetime="2018-06-19T22:57:00-07:00"> 19 Jun 2018</time>
    </span>





    <!-- <span class="label label-default">Tags</span>
	<a href="https://gauravmodi.com/tag/sql.html">sql</a>
        /
	<a href="https://gauravmodi.com/tag/window-functions.html">window functions</a>
        /
	<a href="https://gauravmodi.com/tag/datetime-functions.html">datetime functions</a>
 -->
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>
<p><b><h3>This is one query where I have put all frequently used <span class="caps">SQL</span> functions so to reference the syntax whenever&nbsp;required.</b></h3>
<p><i><b><font color='red'><span class="caps">NOTE</span>: This query as whole is gibberish.</font></b></i></p>

<div class="highlight"><pre><span></span><span class="k">WITH</span>
    <span class="n">cte_table</span> <span class="k">AS</span>
    <span class="p">(</span>
        <span class="k">SELECT</span> <span class="o">*</span>
          <span class="k">FROM</span> <span class="k">table</span>
    <span class="p">),</span>

    <span class="n">cte_derived</span> <span class="k">AS</span>
    <span class="p">(</span>
        <span class="k">SELECT</span> <span class="o">*</span>
          <span class="k">FROM</span> <span class="n">cte_table</span>
    <span class="p">)</span>

<span class="k">SELECT</span> <span class="nf">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">artist</span><span class="p">),</span>

       <span class="c1">-- DATA TYPE CASTING</span>
       <span class="nf">CAST</span><span class="p">(</span><span class="n">sales</span> <span class="k">AS</span> <span class="kt">DECIMAL</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="k">AS</span> <span class="n">sale</span><span class="p">,</span> <span class="c1">-- sales with 3 decimal precisions</span>
                                              <span class="c1">-- and maximum 28 digits</span>
       <span class="n">founded_at_clean</span><span class="p">::</span><span class="kt">TIMESTAMP</span><span class="p">,</span>

       <span class="c1">-- CASE STATEMENT (IF-ELSE)</span>
       <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">weight</span> <span class="o">&gt;</span> <span class="mi">250</span> <span class="k">THEN</span> <span class="s1">&#39;over 250&#39;</span>
            <span class="k">ELSE</span> <span class="s1">&#39;175 or under&#39;</span> <span class="n">END</span> <span class="k">AS</span> <span class="n">weight_group</span><span class="p">,</span>
       <span class="nf">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">full_school_name</span> <span class="o">&lt;</span> <span class="s1">&#39;n&#39;</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="n">END</span><span class="p">)</span> <span class="k">AS</span> <span class="n">a_m</span><span class="p">,</span>

       <span class="c1">-- STRING MANIPULATION</span>
       <span class="k">LEFT</span><span class="p">(</span><span class="kt">date</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="k">AS</span> <span class="n">cleaned_date</span><span class="p">,</span>
       <span class="nf">SUBSTR</span><span class="p">(</span><span class="kt">date</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AS</span> <span class="n">day</span><span class="p">,</span> <span class="o">--</span><span class="n">substring</span> <span class="k">from</span> <span class="mi">4</span> <span class="n">places</span> <span class="k">to</span> <span class="mi">2</span> <span class="n">next</span> <span class="n">positions</span>
       <span class="nf">TRIM</span><span class="p">(</span><span class="k">BOTH</span> <span class="s1">&#39;()@$&#39;</span> <span class="k">FROM</span> <span class="n">location</span><span class="p">),</span> <span class="c1">-- replaces all the characters inside</span>
                                        <span class="c1">-- the TRIM from &#39;BOTH&#39; side left and right</span>
       <span class="nf">POSITION</span><span class="p">(</span><span class="s1">&#39;A&#39;</span> <span class="k">IN</span> <span class="n">descript</span><span class="p">)</span> <span class="k">AS</span> <span class="n">a_position</span><span class="p">,</span> <span class="c1">-- tells the position of &#39;A&#39; in column value</span>
       <span class="nf">CONCAT</span><span class="p">(</span><span class="n">day_of_week</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="p">,</span> <span class="k">LEFT</span><span class="p">(</span><span class="kt">date</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="k">AS</span> <span class="n">day_and_date</span><span class="p">,</span>
       <span class="nf">UPPER</span><span class="p">(</span><span class="n">address</span><span class="p">)</span> <span class="k">AS</span> <span class="n">address_upper</span><span class="p">,</span>
       <span class="nf">LOWER</span><span class="p">(</span><span class="n">address</span><span class="p">)</span> <span class="k">AS</span> <span class="n">address_lower</span><span class="p">,</span>

       <span class="c1">-- DATETIME FUNCTIONS</span>
       <span class="k">CURRENT_DATE</span> <span class="k">AS</span> <span class="kt">date</span><span class="p">,</span>
       <span class="k">CURRENT_TIME</span> <span class="k">AS</span> <span class="kt">time</span><span class="p">,</span>
       <span class="k">CURRENT_TIMESTAMP</span> <span class="k">AS</span> <span class="kt">timestamp</span><span class="p">,</span>
       <span class="k">CURRENT_TIME</span> <span class="n">AT</span> <span class="kt">TIME</span> <span class="n">ZONE</span> <span class="s1">&#39;PST&#39;</span> <span class="k">AS</span> <span class="n">time_pst</span><span class="p">,</span>
       <span class="k">LOCALTIME</span> <span class="k">AS</span> <span class="k">localtime</span><span class="p">,</span>
       <span class="k">LOCALTIMESTAMP</span> <span class="k">AS</span> <span class="k">localtimestamp</span><span class="p">,</span>
       <span class="nf">NOW</span><span class="p">()</span> <span class="k">AS</span> <span class="n">time_now</span><span class="p">,</span>

       <span class="c1">-- DATE MANIPULATION FUNCTIONS</span>
       <span class="n">founded_at_clean</span><span class="p">::</span><span class="kt">TIMESTAMP</span> <span class="o">+</span> <span class="k">INTERVAL</span> <span class="s1">&#39;1 week&#39;</span> <span class="k">AS</span> <span class="n">plus_one_week</span><span class="p">,</span>
       <span class="nf">NOW</span><span class="p">()</span> <span class="o">-</span> <span class="n">founded_at_clean</span><span class="p">::</span><span class="kt">TIMESTAMP</span> <span class="k">AS</span> <span class="n">founded_time_ago</span><span class="p">,</span> <span class="c1">-- current time - some_value</span>

       <span class="c1">-- TIME EXTRACTION FUNCTIONS</span>
       <span class="nf">EXTRACT</span><span class="p">(</span><span class="s1">&#39;month&#39;</span> <span class="k">FROM</span> <span class="n">transaction_date</span><span class="p">::</span><span class="kt">TIMESTAMP</span><span class="p">)</span> <span class="k">AS</span> <span class="n">week</span><span class="p">,</span>
       <span class="nf">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;week&#39;</span><span class="p">,</span> <span class="n">transaction_date</span><span class="p">::</span><span class="kt">DATE</span><span class="p">)</span> <span class="k">AS</span> <span class="n">week</span><span class="p">,</span>

       <span class="c1">-- WINDOW FUNCTIONS: AVG, COUNT, RANK, DENSE_RANK, ROW_NUMBER, LAG, LEAD</span>
       <span class="nf">LAG</span><span class="p">(</span><span class="n">sales</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="nf">OVER</span> <span class="p">()</span> <span class="k">AS</span> <span class="n">sales_last_week</span><span class="p">,</span> <span class="o">--</span><span class="mi">2</span><span class="n">nd</span> <span class="n">lag</span> <span class="n">value</span> <span class="n">of</span>
       <span class="nf">RANK</span><span class="p">()</span> <span class="nf">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">locationID</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">quantity</span> <span class="k">DESC</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Rank</span><span class="p">,</span>
       <span class="nf">SUM</span><span class="p">(</span><span class="n">sales</span><span class="p">)</span> <span class="nf">OVER</span> <span class="p">(</span><span class="n">ROWS</span> <span class="k">BETWEEN</span> <span class="mi">6</span> <span class="n">PRECEDING</span> <span class="k">AND</span> <span class="n">CURRENT</span> <span class="n">ROW</span><span class="p">)</span> <span class="k">AS</span> <span class="n">total_sales_moving_avg_7_days</span><span class="p">,</span>
       <span class="nf">SUM</span><span class="p">(</span><span class="n">sales</span><span class="p">)</span> <span class="nf">OVER</span> <span class="p">(</span><span class="n">ROWS</span> <span class="k">BETWEEN</span> <span class="n">UNBOUNDED</span> <span class="n">PRECEDING</span> <span class="k">AND</span> <span class="n">CURRENT</span> <span class="n">ROW</span><span class="p">)</span> <span class="k">AS</span> <span class="n">total_sales</span><span class="p">,</span>
       <span class="nf">SUM</span><span class="p">(</span><span class="n">duration_seconds</span><span class="p">)</span> <span class="nf">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">start_terminal</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">start_time</span><span class="p">)</span> <span class="k">AS</span> <span class="n">running_total</span><span class="p">,</span>
       <span class="nf">SUM</span><span class="p">(</span><span class="n">sales</span><span class="p">)</span> <span class="nf">OVER</span> <span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">week</span><span class="p">)</span> <span class="k">AS</span> <span class="n">running_total_V2</span> <span class="o">--</span><span class="n">make</span> <span class="n">sure</span> <span class="k">to</span> <span class="n">have</span> <span class="k">order</span> <span class="k">by</span><span class="p">,</span>
       <span class="nf">NTILE</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="nf">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">start_terminal</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">duration_seconds</span><span class="p">)</span> <span class="k">AS</span> <span class="n">quartile</span><span class="p">,</span>

  <span class="k">FROM</span> <span class="n">lag_sales</span> <span class="k">AS</span> <span class="n">w</span>
  <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">tutorial</span><span class="p">.</span><span class="n">crunchbase_acquisitions</span> <span class="n">acquisitions</span>
    <span class="k">ON</span> <span class="n">companies</span><span class="p">.</span><span class="n">permalink</span> <span class="o">=</span> <span class="n">acquisitions</span><span class="p">.</span><span class="n">company_permalink</span>
   <span class="k">AND</span> <span class="n">companies</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">investments</span><span class="p">.</span><span class="n">company_name</span>
   <span class="k">AND</span> <span class="n">investments</span><span class="p">.</span><span class="n">funded_year</span> <span class="o">&gt;</span> <span class="n">companies</span><span class="p">.</span><span class="n">founded_year</span> <span class="o">+</span> <span class="mi">5</span>
 <span class="k">WHERE</span> <span class="s2">&quot;group&quot;</span> <span class="k">LIKE</span> <span class="s1">&#39;Snoop%&#39;</span>
   <span class="k">AND</span> <span class="n">artist</span> <span class="n">ILIKE</span> <span class="s1">&#39;dr_ke&#39;</span> <span class="c1">-- underscore is to match with any character</span>
                            <span class="c1">-- and ILIKE is CASE INsensitive</span>
   <span class="k">AND</span> <span class="n">artist</span> <span class="k">NOT</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">&#39;Taylor Swift&#39;</span><span class="p">,</span> <span class="s1">&#39;Usher&#39;</span><span class="p">,</span> <span class="s1">&#39;Ludacris&#39;</span><span class="p">)</span>
   <span class="k">AND</span> <span class="n">year_rank</span> <span class="k">BETWEEN</span> <span class="mi">5</span> <span class="k">AND</span> <span class="mi">10</span> <span class="c1">-- both extreme values included</span>
    <span class="k">OR</span> <span class="n">artist</span> <span class="k">IS</span> <span class="no">NULL</span>
 <span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">1</span>  <span class="c1">-- Group by first column in SELECT statement</span>
 <span class="k">ORDER</span> <span class="k">BY</span> <span class="mi">1</span> <span class="k">DESC</span>
<span class="n">OFFSET</span> <span class="mi">1</span>     <span class="c1">-- Exclude the first row</span>
 <span class="k">LIMIT</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2018 <a href="https://www.linkedin.com/in/modigaurav01/" target="_blank">Gaurav Modi</a>
            <!-- &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a> -->         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://gauravmodi.com/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://gauravmodi.com/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://gauravmodi.com/theme/js/respond.min.js"></script>


    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-113190159-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->


</body>
</html>